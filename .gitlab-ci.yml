stages:
    - build
    - deploy

variables:
    DOCKER_DRIVER: overlay2

# -----------------------------
# Stage 1: Build Docker image
# -----------------------------
build_image:
    stage: build
    image: docker:latest
    services:
        - docker:dind
    script:
        # Log in to GitLab Registry
        - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

        # Build Docker image from your Dockerfile
        - docker build -t "$CI_REGISTRY_IMAGE:latest" .

        # Push the built image
        - docker push "$CI_REGISTRY_IMAGE:latest"

    only:
        - main
# -----------------------------
# Stage 2: Deploy to VM via SSH
# -----------------------------
# deploy_to_vm:
#     stage: deploy
#     image: alpine:latest

#     before_script:
#         - apk add --no-cache openssh-client

#         # Prepare SSH key
#         - mkdir -p ~/.ssh
#         - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/deploy_key
#         - chmod 600 ~/.ssh/deploy_key

#         # Allow SSH without host key prompt
#         - echo -e "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

#     script:
#         # Pull the latest image on the VM
#         - ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST "docker pull $CI_REGISTRY_IMAGE:latest"

#         # Stop & remove old container
#         - ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST "docker stop mtgcounterplus || true && docker rm mtgcounterplus || true"

#         # Run new container
#         - ssh -i ~/.ssh/deploy_key $DEPLOY_USER@$DEPLOY_HOST "docker run -d --name mtgcounterplus -p 3001:3000 --restart unless-stopped $CI_REGISTRY_IMAGE:latest"

#     only:
#         - main
